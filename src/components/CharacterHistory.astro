---
import Card from "@/components/ui/Card.astro";
import Mapbox from "./history/HistoryMap.vue";
import HistoryMapCard from "./history/details/HistoryMapCard.vue";
import HistoryTimeline from "./history/timeline/HistoryTimeline.vue";
import Scroller from "@/components/ui/client/Scroller.vue";
import { getEntry } from "astro:content";
import { localizePath } from "../utils/locale";

const history = await getEntry("history", localizePath(Astro, "history"))!;
const scroller = await getEntry(
  "section",
  localizePath(Astro, history.data.scroller)
)!;

const steps = history.data.events.map(event => ({
  label: event.label,
  description: event.description,
  coordinate: event.coordinate.coordinates,
  icon: event.icon,
  date: event.endDate ? [event.startDate, event.endDate] : [event.startDate],
}));
---

<section
  id="characterHistory"
  class="relative flex min-h-dvh w-full snap-start flex-col gap-6 pt-16 md:h-dvh md:snap-center"
>
  <div class="flex max-h-full items-center justify-center gap-6">
    <div
      class="flex h-fit max-h-full grow flex-col pt-12 max-md:hidden md:max-w-md lg:max-w-2xl"
    >
      <div class="relative">
        <h1
          data-aos="fade-in"
          class="text-primary-500 absolute -top-2 left-1/2 -translate-x-1/2 -translate-y-full text-2xl font-bold"
        >
          {history.data.title}
        </h1>
        <Card animation="zoom-in">
          <Mapbox client:load class="aspect-[4/3] w-full" steps={steps} />
        </Card>
      </div>
      <HistoryMapCard
        data-aos="zoom-in"
        client:load
        class="mt-6 h-64 lg:hidden"
        steps={steps}
      />
    </div>
    <div>
      <h1
        data-aos="fade-in"
        class="text-primary-500 mx-auto text-center text-2xl font-bold md:hidden"
      >
        Backstory
      </h1>
      <HistoryTimeline
        class="my-auto shrink-0 max-md:mx-auto max-md:h-fit max-md:min-h-full max-md:w-full md:-mb-16"
        data-aos="fade-right"
        client:load
        steps={steps}
      />
    </div>
  </div>
  <Scroller
    class="max-md:hidden"
    data-aos="zoom-in"
    data-aos-offset="-25"
    elementId={scroller.data.target}
    client:load
  >
    {scroller.data.prompt}
  </Scroller>
</section>
